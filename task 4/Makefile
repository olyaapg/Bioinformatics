OUTPUT_DIR = ./output
SEQ = SRR12717711.fastq
REF = GCF_000005845.2_ASM584v2_genomic.fna
REF_INDEX = $(OUTPUT_DIR)/ref_index.mmi
MINIMAP2 = ../minimap2-2.28_x64-linux/minimap2
SAM_FILE = $(OUTPUT_DIR)/mapped_sam.sam
BAM_FILE = $(OUTPUT_DIR)/mapped_bam.bam
SORTED_BAM = $(OUTPUT_DIR)/sorted_mapped_bam.bam
FREEBAYES_RES = $(OUTPUT_DIR)/freebayes_output.vcf
FLAGSTAT_RES = $(OUTPUT_DIR)/flagstat_result
VISUALIZE_FILE_DOT = $(OUTPUT_DIR)/pipeline.dot
VISUALIZE_FILE_PNG = $(OUTPUT_DIR)/pipeline.png

quality_score: $(FLAGSTAT_RES)
	@echo "ðŸ’¥  Let's get the quality score..."
	@VAR=$$(grep "+ 0 mapped" $(FLAGSTAT_RES) | grep -oP '\d+\.\d+'); \
	echo "ðŸ’¥  Result is - $$VAR%"; \
	if [ -z "$$VAR" ]; then \
		echo "âŒ  Quality score not found!"; \
	elif [ "$$(echo "$$VAR > 90" | bc -l)" -eq 1 ]; then \
		echo "âœ…  OK!"; \
	else \
		echo "âŒ  not OK..."; \
	fi

# Ð¥Ð¾Ñ‚Ð¸Ð¼ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ñ†ÐµÐ½ÐºÑƒ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ samtools flagstat
$(FLAGSTAT_RES): $(BAM_FILE)
	@echo "ðŸ’¥  Samtools flagstat is starting to work..."
	samtools flagstat $(BAM_FILE) > $(FLAGSTAT_RES)

# Ð”Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ð¼Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐµ:

# Ð˜Ð½Ð´ÐµÐºÑÐ¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÑ„ÐµÑ€ÐµÐ½ÑÐ½Ñ‹Ð¹ Ð³ÐµÐ½Ð¾Ð¼ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð° minimap2
$(REF_INDEX): $(REF)
	@mkdir -p $(OUTPUT_DIR)
	@echo "ðŸ’¥  Get index of ref with minimap2..."
	$(MINIMAP2) -d $(REF_INDEX) $(REF)

# ÐšÐ°Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð° minimap2
$(SAM_FILE): $(REF_INDEX)
	@echo "ðŸ’¥  Get SAM file with minimap2..."
	$(MINIMAP2) -a $(REF_INDEX) $(SEQ) > $(SAM_FILE)

# ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ SAM Ð² BAM Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ samtools view
$(BAM_FILE): $(SAM_FILE)
	@echo "ðŸ’¥  Convert SAM file into BAM file..."
	samtools view -S -b $(SAM_FILE) > $(BAM_FILE)

# Ð”Ð»Ñ freebayes
$(SORTED_BAM): $(BAM_FILE) $(REF)
	@echo "ðŸ’¥  Samtools sorting..."
	samtools sort $(BAM_FILE) -o $(SORTED_BAM)
	@echo "ðŸ’¥  Indexing ref..."
	samtools faidx $(REF)

index_sorted: $(SORTED_BAM)
	@echo "ðŸ’¥  Indexing sorted_mapped..."
	samtools index $(SORTED_BAM)

freebayes: index_sorted $(SORTED_BAM) $(REF)
	@echo "ðŸ’¥  Freebayes is starting to work..."
	freebayes -f $(REF) $(SORTED_BAM) > $(FREEBAYES_RES)




# Ð§Ð¸ÑÑ‚Ð¸Ð¼ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹, Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð² Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ðµ Ñ€Ð°Ð·Ñ‹
.PHONY: clean
clean:
	rm -r $(OUTPUT_DIR)

# Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ
.PHONY: visualize

# Ð¦ÐµÐ»ÑŒ Ð²Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
visualize: $(VISUALIZE_FILE_DOT)
	dot -Tpng -o $(VISUALIZE_FILE_PNG) $(VISUALIZE_FILE_DOT)

# Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ .dot Ñ„Ð°Ð¹Ð»Ð° Ð¸Ð· Makefile
$(VISUALIZE_FILE_DOT): Makefile
	echo "digraph G {" > $(VISUALIZE_FILE_DOT)
	awk '/^[^#][^ \t]*:/ {print "\"" $$1 "\" -> \"" $$2 "\";"}' $(MAKEFILE_LIST) >> $(VISUALIZE_FILE_DOT)
	echo "}" >> $(VISUALIZE_FILE_DOT)
